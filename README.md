# Deribit Ticker Collector

Простое приложение для сбора и отображения цен BTC/USD и ETH/USD с биржи Deribit.

## Функционал

1. **Сбор данных**: Каждую минуту собирает индексные цены BTC/USD и ETH/USD с Deribit API
2. **Хранение**: Сохраняет данные в PostgreSQL с timestamp
3. **API**: FastAPI с тремя эндпоинтами для доступа к данным
4. **Веб-интерфейс**: Простой dashboard для просмотра данных
5. **Распределенная обработка**: Использует Celery для периодических задач

## Требования

- Docker и Docker Compose
- Python 3.11+ (для локальной разработки)

## Быстрый старт

### Используя Docker (рекомендуется)

1. Клонируйте репозиторий:
```bash
git clone <repository-url>
cd deribit_ticker
```

2. Скопируйте файл с переменными окружения:
```bash
.env
# Database
DB_HOST=localhost
DB_PORT=5432
DB_NAME=deribit_db
DB_USER=postgres
DB_PASSWORD=postgres

# Redis for Celery
REDIS_URL=redis://localhost:6379/0

# Deribit API
DERIBIT_BASE_URL=https://www.deribit.com/api/v2
```

3. Запустите приложение с помощью Docker Compose:
```bash
docker compose up -d
```

4. Приложение будет доступно по адресам:
   - Веб-интерфейс: http://localhost:8000
   - API документация: http://localhost:8000/docs
   - База данных: localhost:5432
   - Redis: localhost:6379

### Локальная установка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Настройте базу данных PostgreSQL

3. Запустите Redis:
```bash
redis-server
```

4. Запустите FastAPI приложение:
```bash
uvicorn app.main:app --reload
```

5. В отдельном терминале запустите Celery worker:
```bash
celery -A app.tasks.celery_app worker --loglevel=info
```

6. В другом терминале запустите Celery beat:
```bash
celery -A app.tasks.celery_app beat --loglevel=info
```

## API Эндпоинты

### GET `/api/ticker/data`
Получение всех сохраненных данных по указанной валюте.

**Параметры:**
- `ticker` (обязательный) - Тикер валюты (`btc_usd` или `eth_usd`)
- `skip` - Количество записей для пропуска
- `limit` - Лимит записей (по умолчанию 100)

### GET `/api/ticker/latest`
Получение последней цены валюты.

**Параметры:**
- `ticker` (обязательный) - Тикер валюты (`btc_usd` или `eth_usd`)

### GET `/api/ticker/price`
Получение цены валюты с фильтром по дате.

**Параметры:**
- `ticker` (обязательный) - Тикер валюты (`btc_usd` или `eth_usd`)
- `date` (обязательный) - Дата в формате ISO 8601 (`YYYY-MM-DDTHH:MM:SS`)

## Примеры запросов

```bash
# Получить все данные по BTC/USD
curl "http://localhost:8000/api/ticker/data?ticker=btc_usd"

# Получить последнюю цену ETH/USD
curl "http://localhost:8000/api/ticker/latest?ticker=eth_usd"

# Получить цену BTC/USD на конкретную дату
curl "http://localhost:8000/api/ticker/price?ticker=btc_usd&date=2024-01-15T12:00:00"
```

## Design Decisions

### 1. Архитектура
- **FastAPI**: Выбран для быстрого создания API с автоматической документацией и асинхронной поддержкой
- **SQLAlchemy 2.0**: Современный ORM с асинхронной поддержкой и строгой типизацией
- **Celery**: Для выполнения периодических задач (сбор данных каждую минуту)
- **Redis**: Брокер сообщений для Celery, легкий и быстрый

### 2. База данных
- **PostgreSQL**: Выбрана как надежная реляционная БД с хорошей производительностью
- **Простая схема**: Одна таблица `ticker_data` с полями: `ticker`, `price`, `timestamp`, `created_at`
- **Индексы**: Индексы на `ticker` и `timestamp` для быстрого поиска по валюте и времени
- **Автосоздание**: Таблицы создаются автоматически при запуске через SQLAlchemy

### 3. Клиент Deribit
- **aiohttp**: Использован для асинхронных HTTP запросов, что позволяет обрабатывать несколько запросов одновременно
- **Индексная цена**: Используется `index_price` как наиболее стабильный показатель, менее волатильный чем spot price
- **Обработка ошибок**: Корректная обработка сетевых ошибок, таймаутов и невалидных ответов API
- **Минимализм**: Клиент делает только необходимые запросы без лишней логики

### 4. Веб-интерфейс
- **Простота**: Минималистичный HTML/CSS/JS интерфейс без сторонних фреймворков
- **Real-time обновление**: Цены обновляются каждую секунду через Fetch API
- **Визуальная обратная связь**: Цвет цены меняется (зеленый/красный) в зависимости от роста/падения
- **Адаптивность**: Работает на мобильных устройствах и десктопах

### 5. Docker
- **Мульти-контейнер**: Отдельные контейнеры для приложения, БД, Redis, Celery worker и Celery beat
- **Health checks**: Проверка работоспособности PostgreSQL и Redis перед запуском приложения
- **Volumes**: Сохранение данных БД и Redis при перезапуске контейнеров
- **Минимальные образы**: Использование slim-образов Python для уменьшения размера

### 6. Безопасность и надежность
- **Без глобальных переменных**: Все настройки через переменные окружения в `.env` файле
- **Валидация данных**: Pydantic схемы для валидации входных данных API
- **CORS**: Настроен для работы с веб-интерфейсом с того же хоста
- **Обработка исключений**: Корректная обработка всех возможных ошибок с понятными сообщениями
- **Логирование**: Информативное логирование для диагностики проблем

### 7. Производительность
- **Асинхронность**: FastAPI и aiohttp позволяют обрабатывать много одновременных запросов
- **Кэширование запросов**: Redis как брокер также может использоваться для кэширования
- **Эффективные запросы**: Использование SQLAlchemy ORM с правильными индексами
- **Пакетная обработка**: Celery обрабатывает периодические задачи в фоне

## Мониторинг

- **FastAPI docs**: http://localhost:8000/docs
- **Health check**: http://localhost:8000/health
- **Логи**: `docker compose logs -f <service_name>`

## Стоп приложение

```bash
docker compose down
```

Для полного удаления данных:
```bash
docker compose down -v
```
